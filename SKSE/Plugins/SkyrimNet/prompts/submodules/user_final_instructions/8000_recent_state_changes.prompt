{% if render_mode == "full" or render_mode == "thoughts" or render_mode == "transform" %}
{# Track vital stats and equipment state changes #}
{% set currentHealth = get_actor_value(npc.UUID, "Health") %}
{% set maxHealth = get_base_actor_value(npc.UUID, "Health") %}
{% set currentMagicka = get_actor_value(npc.UUID, "Magicka") %}
{% set maxMagicka = get_base_actor_value(npc.UUID, "Magicka") %}
{% set currentStamina = get_actor_value(npc.UUID, "Stamina") %}
{% set maxStamina = get_base_actor_value(npc.UUID, "Stamina") %}

{# Get actor information for proper name and pronouns #}
{% set actor = decnpc(npc.UUID) %}

{# Get equipment state for nudity tracking #}
{% set equipment = get_worn_equipment(npc.UUID) %}
{% set hasCuirass = equipment.body %}
{% if hasCuirass %}
{% set cuirassName = equipment.body.name %}
{% else %}
{% set cuirassName = "" %}
{% endif %}

{# Track changes with 60 second window #}
{% set healthChange = track_entity_state(npc.UUID, "status:health", currentHealth, 120) %}
{% set magickaChange = track_entity_state(npc.UUID, "status:magicka", currentMagicka, 120) %}
{% set staminaChange = track_entity_state(npc.UUID, "status:stamina", currentStamina, 120) %}
{% set cuirassChange = track_entity_state(npc.UUID, "status:cuirass", hasCuirass, 120) %}

{# Calculate percentage changes based on max values #}
{% if healthChange.hasPrevious and healthChange.isRecent %}
{% set healthDelta = currentHealth - healthChange.previous %}
{% else %}
{% set healthDelta = 0 %}
{% endif %}
{% if maxHealth > 0 %}
{% set healthPct = healthDelta / maxHealth * 100 %}
{% else %}
{% set healthPct = 0 %}
{% endif %}

{% if magickaChange.hasPrevious and magickaChange.isRecent %}
{% set magickaDelta = currentMagicka - magickaChange.previous %}
{% else %}
{% set magickaDelta = 0 %}
{% endif %}
{% if maxMagicka > 0 %}
{% set magickaPct = magickaDelta / maxMagicka * 100 %}
{% else %}
{% set magickaPct = 0 %}
{% endif %}

{% if staminaChange.hasPrevious and staminaChange.isRecent %}
{% set staminaDelta = currentStamina - staminaChange.previous %}
{% else %}
{% set staminaDelta = 0 %}
{% endif %}
{% if maxStamina > 0 %}
{% set staminaPct = staminaDelta / maxStamina * 100 %}
{% else %}
{% set staminaPct = 0 %}
{% endif %}

{# Check if any significant changes occurred #}
{% set hasHealthChange = healthChange.isRecent and healthChange.changed and (healthPct > 25 or healthPct < -25) %}
{% set hasMagickaChange = magickaChange.isRecent and magickaChange.changed and (magickaPct > 25 or magickaPct < -25) %}
{% set hasStaminaChange = staminaChange.isRecent and staminaChange.changed and (staminaPct > 25 or staminaPct < -25) %}
{% set hasCuirassChanged = cuirassChange.isRecent and cuirassChange.changed %}
{% set hasAnyChange = hasHealthChange or hasMagickaChange or hasStaminaChange or hasCuirassChanged %}

{% if hasAnyChange %}
# Significant Recent Changes
**{{ actor.name }}** just experienced a significant change to {{ actor.possessivePronoun }} physical state. Consider factoring this into the response.

{% if hasHealthChange %}
{% if healthPct <= -75 %}
- CRITICALLY WOUNDED: {{ actor.name }} lost most of {{ actor.possessivePronoun }} health - barely standing, in severe pain
{% elif healthPct <= -50 %}
- BADLY HURT: {{ actor.name }} lost over half {{ actor.possessivePronoun }} health - significant wounds, bleeding, struggling
{% elif healthPct <= -25 %}
- INJURED: {{ actor.name }} lost a quarter of {{ actor.possessivePronoun }} health - noticeable pain, wounds that sting
{% elif healthPct >= 75 %}
- FULLY HEALED: {{ actor.name }} recovered most of {{ actor.possessivePronoun }} health - wounds have closed, strength returns
{% elif healthPct >= 50 %}
- MUCH BETTER: {{ actor.name }} recovered over half {{ actor.possessivePronoun }} health - significant healing, relief floods through
{% elif healthPct >= 25 %}
- RECOVERING: {{ actor.name }} regained some health - wounds starting to mend, pain easing
{% endif %}
{% endif %}

{% if hasMagickaChange %}
{% if magickaPct <= -75 %}
- MAGICALLY DRAINED: {{ actor.name }} expended nearly all magicka - exhausted, can barely sense {{ actor.possessivePronoun }} power
{% elif magickaPct <= -50 %}
- MAGICKA LOW: {{ actor.name }} used over half {{ actor.possessivePronoun }} reserves - feeling the strain of spellcasting
{% elif magickaPct <= -25 %}
- MAGICKA SPENT: {{ actor.name }} used significant magical energy - noticeable fatigue from casting
{% elif magickaPct >= 75 %}
- MAGICKA RESTORED: {{ actor.name }}'s power surges back - fully recharged and ready to cast
{% elif magickaPct >= 50 %}
- MAGICKA RECOVERING: Over half {{ actor.possessivePronoun }} reserves restored - magical strength returning
{% elif magickaPct >= 25 %}
- MAGICKA RETURNING: Some of {{ actor.possessivePronoun }} magical energy recovered - power slowly rebuilding
{% endif %}
{% endif %}

{% if hasStaminaChange %}
{% if staminaPct <= -75 %}
- EXHAUSTED: {{ actor.name }} nearly depleted all stamina - gasping, muscles burning, legs trembling
{% elif staminaPct <= -50 %}
- WINDED: {{ actor.name }} lost over half {{ actor.possessivePronoun }} stamina - breathing hard, body protesting
{% elif staminaPct <= -25 %}
- TIRED: {{ actor.name }} used significant stamina - starting to feel the exertion
{% elif staminaPct >= 75 %}
- FULLY RESTED: {{ actor.name }}'s stamina completely restored - breathing easy, ready for anything
{% elif staminaPct >= 50 %}
- CATCHING BREATH: Over half {{ actor.possessivePronoun }} stamina back - second wind coming
{% elif staminaPct >= 25 %}
- RECOVERING STAMINA: Some of {{ actor.possessivePronoun }} energy returning - breathing steadier now
{% endif %}
{% endif %}

{% if hasCuirassChanged %}
{% if hasCuirass %}
- ARMORED UP: {{ actor.name }} just equipped {{ cuirassName }} - feeling the weight and protection
{% else %}
- EXPOSED: {{ actor.name }} removed {{ actor.possessivePronoun }} body armor - skin now bare, feeling vulnerable without protection
{% endif %}
{% endif %}
{% endif %}
{% endif %}