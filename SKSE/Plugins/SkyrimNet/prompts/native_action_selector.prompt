[ system ]
## Task
Select an action to accompany {{ npc.name }}'s dialogue. Match the action to what they said, did, or agreed to.

## Output Format
- `ACTION: ActionName` — action with no parameters
- `ACTION: ActionName PARAMS: {"param": "value"}` — action with parameters
- `ACTION: None` — no action fits

Output exactly one line starting with `ACTION:` and nothing else.

## Selection Logic
1. **Look at what {{ npc.name }} said, did, or intends to do**
2. If the player requested something and {{ npc.name }} agreed, select the matching action
3. If {{ npc.name }} initiated something (offering items, threatening, propositioning), select the matching action
4. If {{ npc.name }}'s narration describes a physical action, select a matching action if available
5. If no action matches, return `ACTION: None`

## When to Select Actions
- **Player requested something** and {{ npc.name }} agreed → select matching action
- **{{ npc.name }} offered/initiated something** unprompted → select matching action
- **{{ npc.name }}'s narration describes action** (e.g., "*attacks*", "*hands over the key*", "*sits down*") → select matching action
- **Just conversation** with no implied action → `ACTION: None`

## {{ npc.name }}
- {{ render_character_profile("short_inline", npc.UUID) }}
- Race/Gender: {{ decnpc(npc.UUID).gender }} {{ decnpc(npc.UUID).race }}
[ end system ]

[ user ]
## Location
{{ location }}

## Recent Dialogue
{{ render_template("components\\event_history_compact") }}

## {{ npc.name }}'s Line (THIS IS WHAT YOU'RE MATCHING)
"{{ dialogue_request }}
{{ dialogue_response }}"

## Nearby Actors
- {{ decnpc(player.UUID).name }} (Player, {{ decnpc(player.UUID).gender }} {{ decnpc(player.UUID).race }})
{% for npc in get_nearby_npc_list(player.UUID) %}
- {{ decnpc(npc.UUID).name }} ({{ decnpc(npc.UUID).gender }} {{ decnpc(npc.UUID).race }}, {{ units_to_meters(npc.distance) }}m)
{% endfor %}

## Available Actions
{% for action in eligible_actions %}
- `{{ action.name }}`{% if action.parameterSchema and length(action.parameterSchema) > 0 %} PARAMS: {{ action.parameterSchema }}{% endif %} — {{ action.description }}
{% endfor %}
- `None` — No action fits

Output format: `ACTION: [Name]` or `ACTION: [Name] PARAMS: {...}` or `ACTION: None`
[ end user ]
